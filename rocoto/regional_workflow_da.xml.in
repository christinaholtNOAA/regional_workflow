<?xml version="1.0"?>
<!DOCTYPE workflow
[

<!ENTITY USER "{{ user }}">
<!ENTITY machine "HERA">
<!ENTITY ACCOUNT "{{ account }}">

<!ENTITY HOMEfv3 "{{ repo_path }}">
<!ENTITY JOBS "&HOMEfv3;/jobs">
<!ENTITY SCRIPTS "&HOMEfv3;/scripts">
<!ENTITY COMgfs "/scratch4/NCEPDEV/rstprod/com/gfs/prod">
<!ENTITY COMINgfser "/scratch2/NCEPDEV/fv3-cam/noscrub/Eric.Rogers/prfv3rt1">
<!ENTITY OUTDIR "{{ outdir }}">
<!ENTITY DATAROOT "{{ data_in }}">

<!-- rocoto pre command to launch the jobs -->
<!ENTITY PRE "&HOMEfv3;/rocoto/rocoto_pre_job.sh">

<!ENTITY SCHEDULER       "slurm">
<!ENTITY QUEUE_PE        "batch"> <!-- queue for PE (parallel environment) jobs -->
<!ENTITY PE_EXTRA        "">
<!ENTITY QUEUE_SERIAL    "batch"> <!-- queue for serial jobs -->
<!ENTITY SERIAL_EXTRA    "">
<!ENTITY QUEUE_SHARED    "batch">
<!ENTITY SHARED_EXTRA    "">
<!ENTITY QUEUE_SERVICE   "service">
<!ENTITY SERVICE_EXTRA   "">
<!ENTITY DOMAIN          "conus">
<!ENTITY RESERVATION     "">

<!ENTITY THREADS         "24">
<!ENTITY REQUEST_THREADS "<envar><name>PURE_OPENMP_THREADS</name><value>&THREADS;</value></envar><envar><name>OMP_NUM_THREADS</name><value>&THREADS;</value></envar><envar><name>KMP_NUM_THREADS</name><value>&THREADS;</value></envar>">
<!ENTITY MEMORY          "<memory>1G</memory>">
<!ENTITY CORES_EXTRA     "<nodesize>24</nodesize>">
<!ENTITY NODES_EXTRA     "<nodesize>24</nodesize>">
<!ENTITY PURE_OPENMP     "<nodes>1:ppn=1:tpp=24</nodes>">

<!ENTITY CLEANUP_RESOURCES "<walltime>00:10:00</walltime><memory>1G</memory><native>-R affinity[core]</native>">

<!ENTITY CHGRES_IC_RESOURCES "<nodes>4:ppn=3</nodes><envar><name>TOTAL_TASKS</name><value>12</value></envar><envar><name>NCTSK</name><value>3</value></envar><envar><name>OMP_THREADS</name><value>1</value></envar><walltime>00:30:00</walltime>">
<!ENTITY CHGRES_BC_RESOURCES_DA "<nodes>4:ppn=3</nodes><envar><name>TOTAL_TASKS</name><value>12</value></envar><envar><name>NCTSK</name><value>3</value></envar><envar><name>OMP_THREADS</name><value>1</value></envar><walltime>00:30:00</walltime>">
<!ENTITY CHGRES_BC_RESOURCES "<nodes>4:ppn=3</nodes><envar><name>TOTAL_TASKS</name><value>12</value></envar><envar><name>NCTSK</name><value>3</value></envar><envar><name>OMP_THREADS</name><value>1</value></envar><walltime>01:30:00</walltime>">

<!ENTITY FORECAST_EXTRA "<envar><name>NCTSK</name><value>20</value></envar><envar><name>NCNODE</name><value>40</value></envar><envar><name>OMP_THREADS</name><value>2</value></envar><walltime>04:00:00</walltime>">
<!ENTITY FORECAST_EXTRA_DA "<envar><name>NCTSK</name><value>20</value></envar><envar><name>NCNODE</name><value>40</value></envar><envar><name>OMP_THREADS</name><value>2</value></envar><walltime>00:30:00</walltime>">
<!ENTITY FORECAST_RESOURCES "<nodes>71:ppn=20:tpp=2</nodes><envar><name>TOTAL_TASKS</name><value>1404</value></envar><envar><name>TASK_X</name><value>24</value></envar><envar><name>TASK_Y</name><value>54</value></envar><envar><name>WG</name><value>2</value></envar><envar><name>WTPG</name><value>54</value></envar>&FORECAST_EXTRA;">
<!ENTITY FORECAST_RESOURCES_DA "<nodes>71:ppn=20:tpp=2</nodes><envar><name>TOTAL_TASKS</name><value>1404</value></envar><envar><name>TASK_X</name><value>24</value></envar><envar><name>TASK_Y</name><value>54</value></envar><envar><name>WG</name><value>2</value></envar><envar><name>WTPG</name><value>54</value></envar>&FORECAST_EXTRA;">

<!ENTITY POST_EXTRA "<envar><name>NCTSK</name><value>12</value></envar><envar><name>OMP_THREADS</name><value>1</value></envar><walltime>00:30:00</walltime>">
<!ENTITY POST_RESOURCES "<nodes>3:ppn=12</nodes><envar><name>TOTAL_TASKS</name><value>36</value></envar>&POST_EXTRA;">

<!ENTITY ANL_EXTRA "<envar><name>NCTSK</name><value>24</value></envar><envar><name>OMP_THREADS</name><value>1</value></envar><walltime>00:30:00</walltime>">
<!ENTITY ANL_RESOURCES "<nodes>10:ppn=24</nodes><envar><name>TOTAL_TASKS</name><value>240</value></envar>&ANL_EXTRA;">

<!ENTITY ARCHIVE_RESOURCES "<cores>1</cores><memory>5G</memory><walltime>03:00:00</walltime>">

]>


<!--  ************************************************************* -->
<!--  ******************* STARTING THE WORKFLOW ******************* -->

<workflow realtime="F" cyclethrottle="2" scheduler="slurm" taskthrottle="60">

  <cycledef group="analysis">{{ anl_start }} {{ anl_end }} {{ cycle_incr }}</cycledef>
  <cycledef group="pre_forecast">{{ fcst_start }} {{ fcst_end }} {{ cycle_incr }}</cycledef>

  <log>
    <cyclestr>&OUTDIR;/workflow_regional_@Y@m@d@H.log</cyclestr>
  </log>


<!--  **********************************************************************  -->
<!--  **************************** Run chgres ******************************  -->

<!-- Create the initial conditions for pre_forecast -->

  <task name="make_ic_firstguess" maxtries="1" cycledef="pre_forecast">
    <command>&PRE; &JOBS;/JREGIONAL_MAKE_IC</command>
    <jobname><cyclestr>regional_make_ic_firstguess_@Y@m@d@H</cyclestr></jobname>
    <join><cyclestr>&OUTDIR;/regional_make_ic_firstguess_@Y@m@d@H.log</cyclestr></join>
    <account>&ACCOUNT;</account>
    <queue>&QUEUE_PE;</queue>
    &PE_EXTRA;
    &RESERVATION;
    &CHGRES_IC_RESOURCES;

    <envar>
      <name>HOMEfv3</name>
      <value>&HOMEfv3;</value>
    </envar>
    <envar>
      <name>job</name>
      <value>regional_make_ic_firstguess_&DOMAIN;_<cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>machine</name>
      <value>&machine;</value>
    </envar>
    <envar>
      <name>USER</name>
      <value>&USER;</value>
    </envar>
    <envar>
      <name>CDATE</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>tmmark</name>
      <value>tm12</value>
    </envar>
    <envar>
      <name>PDY</name>
      <value><cyclestr>@Y@m@d</cyclestr></value>
    </envar>
    <envar>
      <name>dom</name>
      <value>&DOMAIN;</value>
    </envar>
    <envar>
      <name>cyc</name>
      <value><cyclestr>@H</cyclestr></value>
    </envar>

  </task>

<!-- Create the boundary conditions for the tm12 6-h forecast -->

  <task name="make_bc_pre_fcst" cycledef="pre_forecast" maxtries="1">
    <command>&PRE; &JOBS;/JREGIONAL_MAKE_BC</command>
    <jobname><cyclestr>regional_make_bc_tm12_@Y@m@d@H</cyclestr></jobname>
    <join><cyclestr>&OUTDIR;/regional_make_bc_tm12_@Y@m@d@H.log</cyclestr></join>
    <account>&ACCOUNT;</account>
    <queue>&QUEUE_PE;</queue>
    &PE_EXTRA;
    &RESERVATION;
    &CHGRES_BC_RESOURCES;

    <envar>
     <name>HOMEfv3</name>
     <value>&HOMEfv3;</value>
    </envar>
    <envar>
     <name>job</name>
     <value>regional_make_bc_tm12_&DOMAIN;_<cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>machine</name>
      <value>&machine;</value>
    </envar>
    <envar>
      <name>tmmark</name>
      <value>tm12</value>
    </envar>
    <envar>
      <name>USER</name>
      <value>&USER;</value>
    </envar>
    <envar>
      <name>CDATE</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>PDY</name>
      <value><cyclestr>@Y@m@d</cyclestr></value>
    </envar>
    <envar>
      <name>dom</name>
      <value>&DOMAIN;</value>
    </envar>
    <envar>
      <name>cyc</name>
      <value><cyclestr>@H</cyclestr></value>
    </envar>
    <dependency>
        <taskdep task="make_ic_firstguess"/>
    </dependency>
  </task>

<!--  ***********************************************************************  -->
<!--  ********** Run the 6-h pre-forecast ***********************************  -->

  <task name="forecast_firstguess" maxtries="1">
    <command>&PRE; &JOBS;/JREGIONAL_FORECAST_FIRSTGUESS</command>
    <jobname><cyclestr>regional_forecast_firstguess_@Y@m@d@H</cyclestr></jobname>
    <join><cyclestr>&OUTDIR;/regional_forecast_firstguess_@Y@m@d@H.log</cyclestr></join>
    <account>&ACCOUNT;</account>
    <queue>&QUEUE_PE;</queue>
    &PE_EXTRA;
    &RESERVATION;
    &FORECAST_RESOURCES_DA;

    <envar>
      <name>HOMEfv3</name>
      <value>&HOMEfv3;</value>
    </envar>
    <envar>
      <name>job</name>
      <value>regional_forecast_firstguess_&DOMAIN;_<cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>machine</name>
      <value>&machine;</value>
    </envar>
    <envar>
      <name>tmmark</name>
      <value>tm12</value>
    </envar>
    <envar>
      <name>USER</name>
      <value>&USER;</value>
    </envar>
    <envar>
      <name>CDATE</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>PDY</name>
      <value><cyclestr>@Y@m@d</cyclestr></value>
    </envar>
    <envar>
      <name>dom</name>
      <value>&DOMAIN;</value>
    </envar>
    <envar>
      <name>cyc</name>
      <value><cyclestr>@H</cyclestr></value>
    </envar>
    <dependency>
        <taskdep task="make_bc_tm12"/>
    </dependency>
  </task>

<!--  ***********************************************************************  -->
<!--  ********** Run the post job for the 6-h forecast valid at tm00 ********  -->

  <metatask>
    <var name="fhr">06</var>
    <task name="post#fhr#_firstguess" maxtries="1">
      <command>&PRE; &JOBS;/JREGIONAL_POST_FIRSTGUESS</command>
      <jobname><cyclestr>regional_post_firstguess_@Y@m@d@H</cyclestr></jobname>
      <join><cyclestr>&OUTDIR;/regional_post_firstguess_@Y@m@d@H.log</cyclestr></join>
      <account>&ACCOUNT;</account>
      <queue>&QUEUE_PE;</queue>
      &PE_EXTRA;
      &RESERVATION;
      &POST_RESOURCES;

      <envar>
        <name>HOMEfv3</name>
        <value>&HOMEfv3;</value>
      </envar>
      <envar>
        <name>job</name>
        <value>regional_post_firstguess_&DOMAIN;_<cyclestr>@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>machine</name>
        <value>&machine;</value>
      </envar>
      <envar>
       <name>tmmark</name>
       <value>tm12</value>
      </envar>
      <envar>
        <name>USER</name>
        <value>&USER;</value>
      </envar>
      <envar>
        <name>CDATE</name>
        <value><cyclestr>@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>PDY</name>
        <value><cyclestr>@Y@m@d</cyclestr></value>
      </envar>
      <envar>
        <name>dom</name>
        <value>&DOMAIN;</value>
      </envar>
      <envar>
        <name>cyc</name>
        <value><cyclestr>@H</cyclestr></value>
      </envar>
      <envar>
        <name>fhr</name>
        <value>#fhr#</value>
      </envar>
      <dependency>
        <taskdep task="forecast_firstguess"/>
      </dependency>
    </task>
  </metatask>

<!-- Create the boundary conditions from tm06-tm01 -->

  <metatask name="make_bc_da">
    <var name="mark">01 02 03 04 05 06</var>
    <task name="make_bc_tm#mark#" maxtries="1">
    <command>&PRE; &JOBS;/JREGIONAL_MAKE_BC</command>
    <jobname><cyclestr>regional_make_bc_tm#mark#_@Y@m@d@H</cyclestr></jobname>
    <join><cyclestr>&OUTDIR;/regional_make_bc_tm#mark#_@Y@m@d@H.log</cyclestr></join>
    <account>&ACCOUNT;</account>
    <queue>&QUEUE_PE;</queue>
    &PE_EXTRA;
    &RESERVATION;
    &CHGRES_BC_RESOURCES;

    <envar>
      <name>HOMEfv3</name>
      <value>&HOMEfv3;</value>
    </envar>
    <envar>
      <name>job</name>
      <value>regional_make_bc_tm#mark#_&DOMAIN;_<cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>machine</name>
      <value>&machine;</value>
    </envar>
    <envar>
     <name>tmmark</name>
     <value>tm#mark#</value>
    </envar>
    <envar>
      <name>USER</name>
      <value>&USER;</value>
    </envar>
    <envar>
      <name>CDATE</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>PDY</name>
      <value><cyclestr>@Y@m@d</cyclestr></value>
    </envar>
    <envar>
      <name>dom</name>
      <value>&DOMAIN;</value>
    </envar>
    <envar>
      <name>cyc</name>
      <value><cyclestr>@H</cyclestr></value>
    </envar>
    <dependency>
        <taskdep task="forecast_firstguess"/>
    </dependency>
    </task>
   </metatask>


<!--  ***********************************************************************  -->
<!--  ********** Run the tm06 analysis **************************************  -->

  <task name="analysis_tm06" maxtries="1">
    <command>&PRE; &JOBS;/JREGIONAL_GSIANL_FIRSTGUESS</command>
    <jobname><cyclestr>regional_gsianl_tm06_@Y@m@d@H</cyclestr></jobname>
    <join><cyclestr>&OUTDIR;/regional_gsianl_firstguess_tm06_@Y@m@d@H.log</cyclestr></join>
    <account>&ACCOUNT;</account>
    <queue>&QUEUE_PE;</queue>
    &PE_EXTRA;
    &RESERVATION;
    &ANL_RESOURCES;

    <envar>
      <name>HOMEfv3</name>
      <value>&HOMEfv3;</value>
    </envar>
    <envar>
      <name>job</name>
      <value>regional_gsianl_tm06_&DOMAIN;_<cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>machine</name>
      <value>&machine;</value>
    </envar>
    <envar>
      <name>tmmark</name>
      <value>tm06</value>
    </envar>
    <envar>
      <name>USER</name>
      <value>&USER;</value>
    </envar>
    <envar>
      <name>CDATE</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>PDY</name>
      <value><cyclestr>@Y@m@d</cyclestr></value>
    </envar>
    <envar>
      <name>dom</name>
      <value>&DOMAIN;</value>
    </envar>
    <envar>
      <name>cyc</name>
      <value><cyclestr>@H</cyclestr></value>
    </envar>

    <dependency>
        <taskdep task="make_bc_tm06"/>
    </dependency>

  </task>

<!--  ***********************************************************************  -->
<!--  ********** Run the tm06 fcst - tm01 analysis as a metatask*************  -->
<!--  ***********************************************************************  -->

  <metatask name="da_fcst_analysis_set">
    <var name="mark">06 05 04 03 02</var>
    <var name="next_mark">05 04 03 02 01</var>

    <task name="forecast_tm#mark#" maxtries="1">
     <command>&PRE; &JOBS;/JREGIONAL_FORECAST</command>
     <jobname><cyclestr>regional_forecast_tm#mark#_@Y@m@d@H</cyclestr></jobname>
     <join><cyclestr>&OUTDIR;/regional_forecast_tm#mark#_@Y@m@d@H.log</cyclestr></join>
     <account>&ACCOUNT;</account>
     <queue>&QUEUE_PE;</queue>
     &PE_EXTRA;
     &RESERVATION;
     &FORECAST_RESOURCES_DA;

     <envar>
      <name>HOMEfv3</name>
      <value>&HOMEfv3;</value>
     </envar>
     <envar>
      <name>job</name>
      <value>regional_forecast_tm#mark#_&DOMAIN;_<cyclestr>@Y@m@d@H</cyclestr></value>
     </envar>
     <envar>
      <name>machine</name>
      <value>&machine;</value>
     </envar>
     <envar>
      <name>tmmark</name>
      <value>tm#mark#</value>
     </envar>
     <envar>
      <name>USER</name>
      <value>&USER;</value>
     </envar>
     <envar>
      <name>CDATE</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
     </envar>
     <envar>
      <name>PDY</name>
      <value><cyclestr>@Y@m@d</cyclestr></value>
     </envar>
     <envar>
       <name>dom</name>
       <value>&DOMAIN;</value>
     </envar>
     <envar>
      <name>cyc</name>
      <value><cyclestr>@H</cyclestr></value>
     </envar>

     <dependency>
      <and>
       <taskdep task="analysis_tm#mark#"/>
       <taskdep task="make_bc_tm#mark#"/>
      </and>
     </dependency>

  </task>

  <task name="analysis_tm#next_mark#" maxtries="1">
    <command>&PRE; &JOBS;/JREGIONAL_GSIANL</command>
    <jobname><cyclestr>regional_gsianl_tm#next_mark#_@Y@m@d@H</cyclestr></jobname>
    <join><cyclestr>&OUTDIR;/regional_gsianl_tm#next_mark#_@Y@m@d@H.log</cyclestr></join>
    <account>&ACCOUNT;</account>
    <queue>&QUEUE_PE;</queue>
    &PE_EXTRA;
    &RESERVATION;
    &ANL_RESOURCES;

    <envar>
      <name>HOMEfv3</name>
      <value>&HOMEfv3;</value>
    </envar>
    <envar>
      <name>job</name>
      <value>regional_gsianl_tm#next_mark#_&DOMAIN;_<cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>                        
      <name>machine</name>
      <value>&machine;</value>
    </envar>
    <envar>
      <name>tmmark</name>
      <value>tm#next_mark#</value>
    </envar>
    <envar>
      <name>USER</name>
      <value>&USER;</value>
    </envar>
    <envar>
      <name>CDATE</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>PDY</name>
      <value><cyclestr>@Y@m@d</cyclestr></value>
    </envar>
    <envar>
      <name>dom</name>
      <value>&DOMAIN;</value>
    </envar>
    <envar>
      <name>cyc</name>
      <value><cyclestr>@H</cyclestr></value>
    </envar>

    <dependency>
        <taskdep task="forecast_tm#mark#"/>
    </dependency>
   </task>
  </metatask>

<!--  ***********************************************************************  -->
<!--  ********** Run the post jobs for tm06-tm01 *****************************  -->
<!--  ***********************************************************************  -->

  <metatask>
   <var name="mark">06 05 04 03 02 01</var>
   <metatask>
    <var name="fhr">00 01</var>
    <task name="post_f#fhr#_tm#mark#" maxtries="1">
      <command>&PRE; &JOBS;/JREGIONAL_POST</command>
      <jobname><cyclestr>regional_post_f#fhr#_tm#mark#_@Y@m@d@H</cyclestr></jobname>
      <join><cyclestr>&OUTDIR;/regional_post_f#fhr#_tm#mark#_@Y@m@d@H.log</cyclestr></join>
      <account>&ACCOUNT;</account>
      <queue>&QUEUE_PE;</queue>
      &PE_EXTRA;
      &RESERVATION;
      &POST_RESOURCES;

      <envar>
        <name>HOMEfv3</name>
        <value>&HOMEfv3;</value>
      </envar>
      <envar>
        <name>job</name>
        <value>regional_post_f#fhr#_tm#mark#_&DOMAIN;_<cyclestr>@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>machine</name>
        <value>&machine;</value>
      </envar>
      <envar>
        <name>USER</name>
        <value>&USER;</value>
      </envar>
      <envar>
        <name>CDATE</name>
        <value><cyclestr>@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>PDY</name>
        <value><cyclestr>@Y@m@d</cyclestr></value>
      </envar>
      <envar>
        <name>dom</name>
        <value>&DOMAIN;</value>
      </envar>
      <envar>
        <name>cyc</name>
        <value><cyclestr>@H</cyclestr></value>
      </envar>
      <envar>
        <name>fhr</name>
        <value>#fhr#</value>
      </envar>
      <envar>
        <name>tmmark</name>
        <value>tm#mark#</value>
      </envar>

      <dependency>
        <and>
          <datadep age="05:00"><cyclestr>&DATAROOT;/regional_forecast_tm#mark#_&DOMAIN;_@Y@m@d@H/logf0#fhr#</cyclestr></datadep>
        </and>
      </dependency>
    </task>
   </metatask>
  </metatask>

<!--  ***********************************************************************  -->
<!--  ********** Run the tm01 fcst - tm00 analysis as a metatask*************  -->
<!--  ***********************************************************************  -->

  <metatask name="fcsttm01_anltm00">
    <var name="mark">01</var>
    <var name="next_mark">00</var>

    <task name="forecast_tm#mark#" maxtries="1">
     <command>&PRE; &JOBS;/JREGIONAL_FORECAST</command>
     <jobname><cyclestr>regional_forecast_tm#mark#_@Y@m@d@H</cyclestr></jobname>
     <join><cyclestr>&OUTDIR;/regional_forecast_tm#mark#_@Y@m@d@H.log</cyclestr></join>
     <account>&ACCOUNT;</account>
     <queue>&QUEUE_PE;</queue>
     &PE_EXTRA;
     &RESERVATION;
     &FORECAST_RESOURCES_DA;

     <envar>
      <name>HOMEfv3</name>
      <value>&HOMEfv3;</value>
     </envar>
     <envar>
      <name>job</name>
      <value>regional_forecast_tm#mark#_&DOMAIN;_<cyclestr>@Y@m@d@H</cyclestr></value>
     </envar>
     <envar>
      <name>machine</name>
      <value>&machine;</value>
     </envar>
     <envar>
      <name>tmmark</name>
      <value>tm#mark#</value>
     </envar>
     <envar>
      <name>CDATE</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
     </envar>
     <envar>
      <name>USER</name>
      <value>&USER;</value>
     </envar>
     <envar>
      <name>PDY</name>
      <value><cyclestr>@Y@m@d</cyclestr></value>
     </envar>
     <envar>
       <name>dom</name>
       <value>&DOMAIN;</value>
     </envar>
     <envar>
      <name>cyc</name>
      <value><cyclestr>@H</cyclestr></value>
     </envar>

     <dependency>
      <and>
       <taskdep task="analysis_tm#mark#"/>
       <taskdep task="make_bc_tm#mark#"/>
      </and>
     </dependency>

  </task>

  <task name="analysis_tm#next_mark#" maxtries="1">
    <command>&PRE; &JOBS;/JREGIONAL_GSIANL</command>
    <jobname><cyclestr>regional_gsianl_tm#next_mark#_@Y@m@d@H</cyclestr></jobname>
    <join><cyclestr>&OUTDIR;/regional_gsianl_tm#next_mark#_@Y@m@d@H.log</cyclestr></join>
    <account>&ACCOUNT;</account>
    <queue>&QUEUE_PE;</queue>
    &PE_EXTRA;
    &RESERVATION;
    &ANL_RESOURCES;

    <envar>
     <name>HOMEfv3</name>
     <value>&HOMEfv3;</value>
    </envar>
    <envar>
     <name>job</name>
     <value>regional_gsianl_tm#next_mark#_&DOMAIN;_<cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
     <name>machine</name>
     <value>&machine;</value>
    </envar>
    <envar>
      <name>tmmark</name>
      <value>tm#next_mark#</value>
    </envar>
    <envar>
      <name>CDATE</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>USER</name>
      <value>&USER;</value>
    </envar>
    <envar>
      <name>PDY</name>
      <value><cyclestr>@Y@m@d</cyclestr></value>
    </envar>
    <envar>
      <name>dom</name>
      <value>&DOMAIN;</value>
    </envar>
    <envar>
      <name>cyc</name>
      <value><cyclestr>@H</cyclestr></value>
    </envar>

    <dependency>
        <taskdep task="forecast_tm#mark#"/>
    </dependency>
   </task>
  </metatask>

<!-- Create the boundary conditions for the 60-h forecast -->

  <task name="make_bc_tm00" maxtries="1">
    <command>&PRE; &JOBS;/JREGIONAL_MAKE_BC</command>
    <jobname><cyclestr>regional_make_bc_tm00_@Y@m@d@H</cyclestr></jobname>
    <join><cyclestr>&OUTDIR;/regional_make_bc_tm00_@Y@m@d@H.log</cyclestr></join>
    <account>&ACCOUNT;</account>
    <queue>&QUEUE_PE;</queue>
    &PE_EXTRA;
    &RESERVATION;
    &CHGRES_BC_RESOURCES;

    <envar>
     <name>HOMEfv3</name>
     <value>&HOMEfv3;</value>
    </envar>
    <envar>
     <name>job</name>
     <value>regional_make_bc_tm00_&DOMAIN;_<cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>machine</name>
      <value>&machine;</value>
    </envar>
    <envar>
      <name>tmmark</name>
      <value>tm00</value>
    </envar>
    <envar>
      <name>USER</name>
      <value>&USER;</value>
    </envar>
    <envar>
      <name>CDATE</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>PDY</name>
      <value><cyclestr>@Y@m@d</cyclestr></value>
    </envar>
    <envar>
      <name>dom</name>
      <value>&DOMAIN;</value>
    </envar>
    <envar>
      <name>cyc</name>
      <value><cyclestr>@H</cyclestr></value>
    </envar>

   <dependency>
        <and>
          <datadep age="05:00" minsize="16986972692"><cyclestr>&COMINgfser;/gfs.@Y@m@d/@H/gfs.t@Hz.atmf057.nemsio</cyclestr></datadep>
          <datadep age="05:00" minsize="16986972692"><cyclestr>&COMINgfser;/gfs.@Y@m@d/@H/gfs.t@Hz.atmf060.nemsio</cyclestr></datadep>
          <taskdep task="analysis_tm00"/>
        </and>
    </dependency>

  </task>

<!--  ***********************************************************************  -->
<!--  ************************* Run the 60-h forecast ***********************  -->

  <task name="forecast_tm00" maxtries=".">
    <command>&PRE; &JOBS;/JREGIONAL_FORECAST</command>
    <jobname><cyclestr>regional_forecast_tm00_@Y@m@d@H</cyclestr></jobname>
    <join><cyclestr>&OUTDIR;/regional_forecast_tm00_@Y@m@d@H.log</cyclestr></join>
     <account>&ACCOUNT;</account>
     <queue>&QUEUE_PE;</queue>
     &PE_EXTRA;
     &RESERVATION;
     &FORECAST_RESOURCES;

    <envar>
     <name>HOMEfv3</name>
     <value>&HOMEfv3;</value>
    </envar>
    <envar>
     <name>job</name>
     <value>regional_forecast_tm00_&DOMAIN;_<cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>machine</name>
      <value>&machine;</value>
    </envar>
    <envar>
      <name>tmmark</name>
      <value>tm00</value>
    </envar>
    <envar>
      <name>USER</name>
      <value>&USER;</value>
    </envar>
    <envar>
      <name>CDATE</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>PDY</name>
      <value><cyclestr>@Y@m@d</cyclestr></value>
    </envar>
    <envar>
      <name>dom</name>
      <value>&DOMAIN;</value>
    </envar>
    <envar>
      <name>cyc</name>
      <value><cyclestr>@H</cyclestr></value>
    </envar>

    <dependency>
      <and>
        <taskdep task="analysis_tm00"/>
        <taskdep task="make_bc_tm00"/>
      </and>
    </dependency>

  </task>

<!--  *******************************************************************  -->
<!--  ********************** Run the post processor *********************  -->

  <metatask name="post_tm00">
    <var name="fhr">00 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60</var>
    <task name="post#fhr#" maxtries=".">
      <command>&PRE; &JOBS;/JREGIONAL_POST</command>
      <jobname><cyclestr>regional_postf#fhr#_@Y@m@d@H</cyclestr></jobname>
      <join><cyclestr>&OUTDIR;/regional_post_f#fhr#_@Y@m@d@H_tm00.log</cyclestr></join>
      <account>&ACCOUNT;</account>
      <queue>&QUEUE_PE;</queue>
      &PE_EXTRA;
      &RESERVATION;
      &POST_RESOURCES;
   
      <envar>
       <name>HOMEfv3</name>
       <value>&HOMEfv3;</value>
      </envar>
      <envar>
       <name>job</name>
       <value>regional_post_f#fhr#_&DOMAIN;_<cyclestr>@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>machine</name>
        <value>&machine;</value>
      </envar>
      <envar>
        <name>tmmark</name>
        <value>tm00</value>
      </envar>
      <envar>
        <name>USER</name>
        <value>&USER;</value>
      </envar>
      <envar>
        <name>CDATE</name>
        <value><cyclestr>@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>PDY</name>
        <value><cyclestr>@Y@m@d</cyclestr></value>
      </envar>
      <envar>
        <name>dom</name>
        <value>&DOMAIN;</value>
      </envar>
      <envar>
        <name>cyc</name>
        <value><cyclestr>@H</cyclestr></value>
      </envar>
      <envar>
        <name>fhr</name>
        <value>#fhr#</value>
      </envar>

      <dependency>
        <and>
         <datadep age="05:00"><cyclestr>&DATAROOT;/regional_forecast_tm00_&DOMAIN;_@Y@m@d@H/logf0#fhr#</cyclestr></datadep>
        </and>
      </dependency>
    </task>
  </metatask>

<!--  **********************************************************************  -->
<!--  ******************************* Cleanup ******************************  -->

  <task name="cleanup" maxtries=".">
    <command>&PRE; &JOBS;/JREGIONAL_CLEANUP</command>
    <jobname><cyclestr>regional_cleanup_@Y@m@d@H</cyclestr></jobname>
    <join><cyclestr>&OUTDIR;/regional_cleanup_@Y@m@d@H.log</cyclestr></join>
    <account>&ACCOUNT;</account>
    <queue>&QUEUE_SHARED;</queue>
    &SHARED_EXTRA;
    &RESERVATION;
    &ARCHIVE_RESOURCES;

    <envar>
      <name>HOMEfv3</name>
      <value>&HOMEfv3;</value>
    </envar>
    <envar>
      <name>USER</name>
      <value>&USER;</value>
    </envar>
    <envar>
      <name>job</name>
      <value>regional_cleanup_&DOMAIN;_<cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>machine</name>
      <value>&machine;</value>
    </envar>
    <envar>
      <name>CDATE</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>PDY</name>
      <value><cyclestr>@Y@m@d</cyclestr></value>
    </envar>
    <envar>
      <name>dom</name>
      <value>&DOMAIN;</value>
    </envar>
    <envar>
      <name>cyc</name>
      <value><cyclestr>@H</cyclestr></value>
    </envar>
    <dependency>
       <metataskdep metatask="post_tm00"/>
    </dependency>
  </task>

</workflow>
