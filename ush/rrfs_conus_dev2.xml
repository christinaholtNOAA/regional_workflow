<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE workflow [

<!--
SECTION 1:
Variables that are modified by the workflow generation script.
-->

<!--
The following are variables that are not passed to the shell scripts 
that execute the various worklflow tasks but are used in other ways by
the workflow XML.
-->
<!ENTITY ACCOUNT       "nrtrr">
<!ENTITY SCHED         "slurm"> 
<!ENTITY PARTITION_DEFAULT  "xjet:kjet:vjet:sjet">
<!ENTITY PARTITION_FCST     "xjet:kjet:vjet:sjet:tjet">
<!ENTITY QUEUE_DEFAULT "batch">
<!ENTITY QUEUE_HPSS    "service">
<!ENTITY QUEUE_FCST    "batch">

<!ENTITY USHDIR  "/home/rtrr/RRFS/ush/conus_dev2">
<!ENTITY JOBSDIR "/home/rtrr/RRFS/jobs">
<!ENTITY EXPTDIR "/mnt/lfs4/BMC/nrtrr/RRFS/conus_dev2/run">
<!ENTITY LOGDIR  "/mnt/lfs4/BMC/nrtrr/RRFS/conus_dev2/log">
<!--<!ENTITY GFSROOT "/public/data/grids/gfs/nemsio">
-->
<!ENTITY RAPROOT "/misc/whome/rtrr/rap/@Y@m@d@H/postprd">
<!ENTITY HRRRROOT "/misc/whome/rtrr/hrrr/@Y@m@d@H/postprd">
<!ENTITY DATAROOT "/mnt/lfs4/BMC/nrtrr/RRFS/conus_dev2/run">
<!ENTITY POST_PREFIX "RRFS_CONUS">
<!ENTITY ARCHIVEDIR "/5year/BMC/wrfruc/rrfs_dev2">
<!ENTITY RESTARTROOT "/mnt/lfs4/BMC/nrtrr/RRFS/conus_dev2/run/@Y@m@d@H">

<!ENTITY NCARG_ROOT         "/apps/ncl/6.5.0-CentOS6.10_64bit_nodap_gnu447">
<!ENTITY NCL_HOME           "/home/rtrr/RRFS/graphics">
<!ENTITY NCL_REGION         "conus">
<!ENTITY GRAPHIC_TITLE      "RRFS (HRRRX/DA)">

<!ENTITY EXTRN_MDL_NAME_ICS  "HRRRX">
<!ENTITY EXTRN_MDL_NAME_LBCS "RAPX">

<!ENTITY EXTRN_MDL_FILES_SYSBASEDIR_ICS  "/misc/whome/rtrr/hrrr/@Y@m@d@H/postprd">
<!ENTITY EXTRN_MDL_FILES_SYSBASEDIR_LBCS "/misc/whome/rtrr/rap/@Y@m@d@H/postprd">

<!ENTITY DATE_FIRST_CYCL "20200519">
<!ENTITY DATE_LAST_CYCL  "20200531">
<!ENTITY YYYY_FIRST_CYCL "2020">
<!ENTITY MM_FIRST_CYCL   "05">
<!ENTITY DD_FIRST_CYCL   "19">
<!ENTITY HH_FIRST_CYCL   "12">

<!ENTITY FHR "00 01 02 03 04 05 06 07 08 09 10 11 12">

<!ENTITY RUN_TASK_MAKE_GRID      "FALSE">
<!ENTITY RUN_TASK_MAKE_OROG      "FALSE">
<!ENTITY RUN_TASK_MAKE_SFC_CLIMO "FALSE">

<!--
The following are variables that are passed to the shell scripts that 
execute the various workflow tasks but are not otherwise used in the 
workflow XML.
-->
<!ENTITY GLOBAL_VAR_DEFNS_FP "/home/rtrr/RRFS/xml/conus_dev2/var_defns.sh">
<!ENTITY CYCLE_DIR           "/mnt/lfs4/BMC/nrtrr/RRFS/conus_dev2/run/@Y@m@d@H">
<!ENTITY CYCLE_ROOT          "/mnt/lfs4/BMC/nrtrr/RRFS/conus_dev2/run">

<!-- 
Task names.
-->
<!ENTITY MAKE_GRID_TN      "make_grid">
<!ENTITY MAKE_OROG_TN      "make_orog">
<!ENTITY MAKE_SFC_CLIMO_TN "make_sfc_climo">
<!ENTITY GET_EXTRN_ICS_TN  "get_extrn_ics">
<!ENTITY GET_EXTRN_LBCS_TN "get_extrn_lbcs">
<!ENTITY MAKE_ICS_TN       "make_ics">
<!ENTITY MAKE_LBCS_TN      "make_lbcs">
<!ENTITY RUN_FCST_TN       "run_fcst">
<!ENTITY RUN_POST_TN       "run_post">
<!ENTITY RUN_BUFR_TN       "run_bufr">
<!ENTITY RUN_NCL_TN        "run_ncl">
<!ENTITY RUN_NCL_ZIP_TN    "run_ncl_zip">
<!ENTITY CLEAN_TN          "run_clean">
<!ENTITY ARCHIVE_TN        "run_archive">

<!ENTITY ANAL_GSI_INPUT_TN "anal_gsi_input">
<!ENTITY ANAL_GSI_RESTA_TN "anal_gsi_resta">
<!ENTITY PROCESS_RADAR_REF_TN "process_radarref">
<!ENTITY RADAR_REFL2TTEN_TN "radar_refl2tten">

<!--
SECTION 2:
Variables that are not modified by the workflow generation script.
-->

<!ENTITY PROC_MAKE_GRID           "1:ppn=24">
<!ENTITY PROC_MAKE_OROG           "1:ppn=24">
<!ENTITY PROC_MAKE_SFC_CLIMO      "2:ppn=24">
<!ENTITY PROC_GET_EXTRN_MDL_FILES "1:ppn=1">
<!ENTITY PROC_MAKE_ICS_SURF_LBC0  "4:ppn=12">
<!ENTITY PROC_MAKE_LBC1_TO_LBCN   "4:ppn=12">
<!ENTITY PROC_RUN_FCST            "240">
<!ENTITY PROC_POST                "4:ppn=12">
<!ENTITY PROC_BUFR                "1:ppn=24">
<!ENTITY PROC_NCL                 "16">
<!ENTITY PROC_NCL_ZIP             "1">
<!ENTITY PROC_CLEAN               "1">
<!ENTITY PROC_ARCHIVE             "1">
<!ENTITY PROC_ANAL_GSI            "8:ppn=24">
<!ENTITY PROC_PRCS_RADARREF       "2:ppn=24">
<!ENTITY PROC_REFL2TTEN           "1:ppn=1">

<!ENTITY RSRC_MAKE_GRID           "<walltime>00:10:00</walltime>">
<!ENTITY RSRC_MAKE_OROG           "<walltime>00:10:00</walltime>">
<!ENTITY RSRC_MAKE_SFC_CLIMO      "<walltime>00:25:00</walltime>">
<!ENTITY RSRC_GET_EXTRN_MDL_FILES "<walltime>00:45:00</walltime>">
<!ENTITY RSRC_MAKE_ICS_SURF_LBC0  "<walltime>00:30:00</walltime>">
<!ENTITY RSRC_MAKE_LBC1_TO_LBCN   "<walltime>01:00:00</walltime>">
<!ENTITY RSRC_RUN_FCST            "<walltime>03:30:00</walltime>">
<!ENTITY RSRC_POST                "<walltime>00:30:00</walltime>">
<!ENTITY RSRC_BUFR                "<walltime>01:30:00</walltime>">
<!ENTITY RSRC_NCL                 "<walltime>00:30:00</walltime><memory>24G</memory>"> 
<!ENTITY RSRC_NCL_ZIP             "<walltime>00:15:00</walltime><memory>2G</memory>">
<!ENTITY RSRC_ARCHIVE             "<walltime>04:00:00</walltime><memory>24G</memory>">
<!ENTITY RSRC_CLEAN               "<walltime>00:15:00</walltime>">
<!ENTITY RSRC_ANAL_GSI            "<walltime>00:30:00</walltime>">
<!ENTITY RSRC_PRCS_RADARREF       "<walltime>00:10:00</walltime>">
<!ENTITY RSRC_REFL2TTEN           "<walltime>00:10:00</walltime><memory>24G</memory>">

<!ENTITY RSRV_DEFAULT  "<queue>&QUEUE_DEFAULT;</queue><account>&ACCOUNT;</account><partition>&PARTITION_DEFAULT;</partition>"> 
<!ENTITY RSRV_HPSS     "<partition>&QUEUE_HPSS;</partition><account>&ACCOUNT;</account>"> 
<!ENTITY RSRV_RUN_FCST "<queue>&QUEUE_FCST;</queue><account>&ACCOUNT;</account><partition>&PARTITION_FCST;</partition>"> 
<!ENTITY NATIVE_RUN_FCST "<native>--cpus-per-task 4 --exclusive</native>">

<!ENTITY DEADLINE_PRE      "16:00:00">
<!ENTITY DEADLINE_FCST     "23:30:00">
<!ENTITY DEADLINE_POST     "24:00:00">
<!ENTITY DEADLINE_GRAPHICS "24:00:00">

<!ENTITY START_TIME_CONVENTIONAL "00:37:00">
 
<!ENTITY WALL_LIMIT_PRE '<deadline><cyclestr offset="&DEADLINE_PRE;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_FCST '<deadline><cyclestr offset="&DEADLINE_FCST;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_POST '<deadline><cyclestr offset="&DEADLINE_POST;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_BUFR '<deadline><cyclestr offset="&DEADLINE_POST;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_GRAPHICS '<deadline><cyclestr offset="&DEADLINE_GRAPHICS;">@Y@m@d@H@M</cyclestr></deadline>'>

<!-- 
Shell script to load task-specific modules and then run the task (while
killing itelf off) using the exec command.
-->
<!ENTITY LOAD_MODULES_RUN_TASK_FP "&USHDIR;/load_modules_run_task.sh">

]>

<workflow realtime="T" scheduler="&SCHED;" cyclethrottle="30" cyclelifespan="01:00:00:00">
 
  <cycledef group="12hr">00 00,12 * 08,09 2020 *</cycledef>
  <cycledef group="03hr">00 03,06,09,15,18,21 * 08,09 2020 *</cycledef>
  <cycledef group="archive">00 08 10 09 2020 *</cycledef>

  <log>
    <cyclestr>&LOGDIR;/workflow_@Y@m@d@H.log</cyclestr>
  </log>
<!--
************************************************************************
************************************************************************
-->
  <task name="&GET_EXTRN_ICS_TN;" cycledefs="12hr" maxtries="3">

    &RSRC_GET_EXTRN_MDL_FILES;
    &RSRV_HPSS;
    &WALL_LIMIT_PRE;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&GET_EXTRN_ICS_TN;" "&JOBSDIR;/JREGIONAL_GET_EXTRN_FILES"</command>
    <nodes>&PROC_GET_EXTRN_MDL_FILES;</nodes>
    <jobname>&GET_EXTRN_ICS_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&GET_EXTRN_ICS_TN;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>EXTRN_MDL_NAME</name><value>&EXTRN_MDL_NAME_ICS;</value></envar>
    <envar><name>ICS_OR_LBCS</name><value>ICS</value></envar>

    <dependency>
      <and>
       <datadep age="00:00:05:00"><cyclestr>&HRRRROOT;/wrfnat_hrconus_00.grib2</cyclestr></datadep>
      </and>
    </dependency>

  </task> 
<!--
************************************************************************
************************************************************************
-->
  <task name="&GET_EXTRN_LBCS_TN;" cycledefs="12hr,03hr" maxtries="3">

    &RSRC_GET_EXTRN_MDL_FILES;
    &RSRV_HPSS;
    &WALL_LIMIT_PRE;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&GET_EXTRN_LBCS_TN;" "&JOBSDIR;/JREGIONAL_GET_EXTRN_FILES"</command>
    <nodes>&PROC_GET_EXTRN_MDL_FILES;</nodes>
    <jobname>&GET_EXTRN_LBCS_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&GET_EXTRN_LBCS_TN;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>EXTRN_MDL_NAME</name><value>&EXTRN_MDL_NAME_LBCS;</value></envar>
    <envar><name>ICS_OR_LBCS</name><value>LBCS</value></envar>

    <dependency>
      <and>
        <datadep age="00:00:05:00"><cyclestr offset="-3:00:00">&RAPROOT;/wrfnat_130_03.grib2</cyclestr></datadep>
        <datadep age="00:00:05:00"><cyclestr offset="-3:00:00">&RAPROOT;/wrfnat_130_06.grib2</cyclestr></datadep>
        <datadep age="00:00:05:00"><cyclestr offset="-3:00:00">&RAPROOT;/wrfnat_130_09.grib2</cyclestr></datadep>
        <datadep age="00:00:05:00"><cyclestr offset="-3:00:00">&RAPROOT;/wrfnat_130_12.grib2</cyclestr></datadep>
      </and>
    </dependency>

  </task> 
<!--
************************************************************************
************************************************************************
-->
  <task name="&MAKE_ICS_TN;" cycledefs="12hr" maxtries="2">

    &RSRC_MAKE_ICS_SURF_LBC0;
    &RSRV_DEFAULT;
    &WALL_LIMIT_PRE;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&MAKE_ICS_TN;" "&JOBSDIR;/JREGIONAL_MAKE_ICS"</command>
    <nodes>&PROC_MAKE_ICS_SURF_LBC0;</nodes>
    <jobname>&MAKE_ICS_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&MAKE_ICS_TN;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>

    <dependency>
      <and>
        <taskdep task="&GET_EXTRN_ICS_TN;"/>
        <or>
<!--          <taskdep task="make_grid"/> -->
          <datadep age="00:00:00:05">&LOGDIR;/make_grid_task_complete.txt</datadep>
          <streq><left>&RUN_TASK_MAKE_GRID;</left><right>FALSE</right></streq>
        </or>
        <or>
<!--          <taskdep task="&MAKE_OROG_TN;"/> -->
          <datadep age="00:00:00:05">&LOGDIR;/&MAKE_OROG_TN;_task_complete.txt</datadep>
          <streq><left>&RUN_TASK_MAKE_OROG;</left><right>FALSE</right></streq>
        </or>
        <or>
<!--          <taskdep task="&MAKE_SFC_CLIMO_TN;"/> -->
          <datadep age="00:00:00:05">&LOGDIR;/&MAKE_SFC_CLIMO_TN;_task_complete.txt</datadep>
          <streq><left>&RUN_TASK_MAKE_SFC_CLIMO;</left><right>FALSE</right></streq>
        </or>
      </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="&MAKE_LBCS_TN;" cycledefs="12hr,03hr" maxtries="2">

    &RSRC_MAKE_LBC1_TO_LBCN;
    &RSRV_DEFAULT;
    &WALL_LIMIT_PRE;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&MAKE_LBCS_TN;" "&JOBSDIR;/JREGIONAL_MAKE_LBCS"</command>
    <nodes>&PROC_MAKE_LBC1_TO_LBCN;</nodes>
    <jobname>&MAKE_LBCS_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&MAKE_LBCS_TN;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>

    <dependency>
      <and>
        <taskdep task="&GET_EXTRN_LBCS_TN;"/>
        <or>
<!--          <taskdep task="make_grid"/> -->
          <datadep age="00:00:00:05">&LOGDIR;/make_grid_task_complete.txt</datadep>
          <streq><left>&RUN_TASK_MAKE_GRID;</left><right>FALSE</right></streq>
        </or>
        <or>
<!--          <taskdep task="&MAKE_OROG_TN;"/> -->
          <datadep age="00:00:00:05">&LOGDIR;/&MAKE_OROG_TN;_task_complete.txt</datadep>
          <streq><left>&RUN_TASK_MAKE_OROG;</left><right>FALSE</right></streq>
        </or>
        <or>
<!--          <taskdep task="&MAKE_SFC_CLIMO_TN;"/> -->
          <datadep age="00:00:00:05">&LOGDIR;/&MAKE_SFC_CLIMO_TN;_task_complete.txt</datadep>
          <streq><left>&RUN_TASK_MAKE_SFC_CLIMO;</left><right>FALSE</right></streq>
        </or>
      </and>
    </dependency>

  </task>
<!--
     ************************************************************************
************************************************************************
-->
  <task name="&ANAL_GSI_INPUT_TN;" cycledefs="12hr" maxtries="3">

    &RSRC_ANAL_GSI;
    &RSRV_DEFAULT;
    <!--&WALL_LIMIT_WHOLE;-->

    <command>&LOAD_MODULES_RUN_TASK_FP; "&ANAL_GSI_INPUT_TN;" "&JOBSDIR;/JREGIONAL_RUN_ANAL"</command>
    <nodes>&PROC_ANAL_GSI;</nodes>
    <jobname>&ANAL_GSI_INPUT_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&ANAL_GSI_INPUT_TN;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
    <envar><name>CYCLE_ROOT</name><value><cyclestr>&CYCLE_ROOT;</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>BKTYPE</name><value><cyclestr>1</cyclestr></value></envar>

    <dependency>
      <and>
        <taskdep task="&MAKE_ICS_TN;"/>
         <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
      </and>
    </dependency>

  </task>

<!--
     ************************************************************************
************************************************************************
-->
  <task name="&ANAL_GSI_RESTA_TN;" cycledefs="03hr" maxtries="3">

    &RSRC_ANAL_GSI;
    &RSRV_DEFAULT;
    <!--&WALL_LIMIT_WHOLE;-->

    <command>&LOAD_MODULES_RUN_TASK_FP; "&ANAL_GSI_RESTA_TN;" "&JOBSDIR;/JREGIONAL_RUN_ANAL"</command>
    <nodes>&PROC_ANAL_GSI;</nodes>
    <jobname>&ANAL_GSI_RESTA_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&ANAL_GSI_RESTA_TN;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
    <envar><name>CYCLE_ROOT</name><value><cyclestr>&CYCLE_ROOT;</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>BKTYPE</name><value><cyclestr>0</cyclestr></value></envar>

    <dependency>
      <and>
        <taskdep task="&MAKE_LBCS_TN;"/>
        <datadep age="00:00:05:00"><cyclestr offset="-3:00:00">&RESTARTROOT;/dynf003.nc</cyclestr></datadep>
        <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
      </and>
    </dependency>

  </task>

<!--
************************************************************************
************************************************************************
-->
  <task name="&RUN_FCST_TN;" cycledefs="12hr,03hr" maxtries="1">

    &RSRC_RUN_FCST;
    &RSRV_RUN_FCST;
    &NATIVE_RUN_FCST;
    &WALL_LIMIT_FCST;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_FCST_TN;" "&JOBSDIR;/JREGIONAL_RUN_FCST_CYCLE"</command>
    <cores>&PROC_RUN_FCST;</cores>
    <jobname>&RUN_FCST_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&RUN_FCST_TN;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>

    <dependency>
      <and>
        <or>
           <taskdep task="&ANAL_GSI_INPUT_TN;"/>
           <taskdep task="&ANAL_GSI_RESTA_TN;"/>
        </or>
        <taskdep task="&MAKE_LBCS_TN;"/>
      </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <metatask name="&RUN_POST_TN;">
    
    <var name="fhr">&FHR;</var>
    
    <task name="&RUN_POST_TN;_#fhr#" cycledefs="12hr,03hr" maxtries="5">
    
      &RSRC_POST;
      &RSRV_DEFAULT;
      &WALL_LIMIT_POST;

      <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_POST_TN;" "&JOBSDIR;/JREGIONAL_RUN_POST"</command>
      <nodes>&PROC_POST;</nodes>
      <jobname>&RUN_POST_TN;_#fhr#</jobname>
      <join><cyclestr>&LOGDIR;/&RUN_POST_TN;_#fhr#_@Y@m@d@H.log</cyclestr></join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
      <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar><name>POST_PREFIX</name><value><cyclestr>&POST_PREFIX;</cyclestr></value></envar>


      <dependency>
        <and>
          <datadep age="05:00"><cyclestr>&CYCLE_DIR;/dynf0#fhr#.nc</cyclestr></datadep>
          <datadep age="05:00"><cyclestr>&CYCLE_DIR;/phyf0#fhr#.nc</cyclestr></datadep>
        </and>
      </dependency>

    </task>

  </metatask>
<!--
************************************************************************
************************************************************************
-->
    <task name="&RUN_BUFR_TN;" cycledefs="12hr" maxtries="2">
    
      &RSRC_BUFR;
      &RSRV_DEFAULT;
      &WALL_LIMIT_BUFR;

      <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_BUFR_TN;" "&JOBSDIR;/JREGIONAL_BUFR"</command>
      <nodes>&PROC_BUFR;</nodes>
      <jobname>&RUN_BUFR_TN;</jobname>
      <join><cyclestr>&LOGDIR;/&RUN_BUFR_TN;_@Y@m@d@H.log</cyclestr></join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
      <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>POST_PREFIX</name><value><cyclestr>&POST_PREFIX;</cyclestr></value></envar>

      <dependency>
        <and>
          <datadep age="05:00"><cyclestr>&CYCLE_DIR;/dynf012.nc</cyclestr></datadep>
          <datadep age="05:00"><cyclestr>&CYCLE_DIR;/phyf012.nc</cyclestr></datadep>
        </and>
      </dependency>

    </task>

<!--
************************************************************************
************************************************************************
-->
  <metatask mode="serial" name="&RUN_NCL_TN;">

    <var name="fhr">&FHR;</var>

    <task name="&RUN_NCL_TN;_#fhr#" cycledefs="12hr" maxtries="2">

      &RSRC_NCL;
      &RSRV_DEFAULT;
      &WALL_LIMIT_GRAPHICS;

      <command>&JOBSDIR;/../scripts/exregional_run_ncl.ksh</command>
      <cores>&PROC_NCL;</cores>
      <jobname>&RUN_NCL_TN;_#fhr#</jobname>
      <join><cyclestr>&LOGDIR;/&RUN_NCL_TN;_#fhr#_@Y@m@d@H.log</cyclestr></join>

      <envar><name>START_TIME</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
      <envar><name>FCST_TIME</name><value>#fhr#</value></envar>
      <envar><name>DATAROOT</name><value>&EXPTDIR;</value></envar>
      <envar><name>DATAHOME</name><value><cyclestr>&EXPTDIR;/@Y@m@d@H</cyclestr></value></envar>
      <envar><name>NCARG_ROOT</name><value>&NCARG_ROOT;</value></envar>
      <envar><name>NCL_HOME</name><value>&NCL_HOME;</value></envar>
      <envar><name>NCL_REGION</name><value>&NCL_REGION;</value></envar>
      <envar><name>MODEL</name><value>&GRAPHIC_TITLE;</value></envar>
      <envar><name>POST_PREFIX</name><value><cyclestr>&POST_PREFIX;</cyclestr></value></envar>

      <dependency>
          <taskdep task="&RUN_POST_TN;_#fhr#"/>
      </dependency>

    </task>

   </metatask>
<!--
************************************************************************
************************************************************************
-->
   <metatask mode="serial" name="&RUN_NCL_ZIP_TN;">

    <var name="fhr">&FHR;</var>

    <task name="&RUN_NCL_ZIP_TN;_#fhr#" cycledefs="12hr" maxtries="2">

      &RSRC_NCL_ZIP;
      &RSRV_DEFAULT;
      &WALL_LIMIT_GRAPHICS;

      <command>&JOBSDIR;/../scripts/exregional_run_ncl_zip.ksh</command>
      <cores>&PROC_NCL_ZIP;</cores>
      <jobname>&RUN_NCL_ZIP_TN;_#fhr#</jobname>
      <join><cyclestr>&LOGDIR;/&RUN_NCL_ZIP_TN;_#fhr#_@Y@m@d@H.log</cyclestr></join>

      <envar><name>START_TIME</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
      <envar><name>FCST_TIME</name><value>#fhr#</value></envar>
      <envar><name>DATAROOT</name><value>&EXPTDIR;</value></envar>
      <envar><name>DATAHOME</name><value><cyclestr>&EXPTDIR;/@Y@m@d@H</cyclestr></value></envar>

      <dependency>
        <or>
        <!--  <taskdep state="Dead" task="&RUN_POST_TN;_#fhr#"/> -->
          <taskdep task="&RUN_NCL_TN;_#fhr#"/>
        </or>
      </dependency>

    </task>

   </metatask>

  <task name="&CLEAN_TN;" cycledefs="12hr" maxtries="1">

    &RSRC_CLEAN;
    &RSRV_DEFAULT;

    <command>&JOBSDIR;/../scripts/exregional_clean.ksh</command>
    <cores>&PROC_CLEAN;</cores>
    <jobname>&CLEAN_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&CLEAN_TN;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>EXPTDIR</name><value>&EXPTDIR;</value></envar>
    <envar><name>LOGDIR</name><value>&LOGDIR;</value></envar>

  </task>

<!--
  <task name="&ARCHIVE_TN;" cycledefs="archive" maxtries="1">

    &RSRC_ARCHIVE;
    &RSRV_HPSS;

    <command>&JOBSDIR;/../scripts/exregional_archive.ksh</command>
    <cores>&PROC_ARCHIVE;</cores>
    <jobname>&ARCHIVE_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&ARCHIVE_TN;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>EXPTDIR</name><value>&EXPTDIR;</value></envar>
    <envar><name>ARCHIVEDIR</name><value>&ARCHIVEDIR;</value></envar>

  </task>
-->

</workflow>
